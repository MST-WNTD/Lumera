@model ClientBrowseViewModel
@using Lumera.Models.ViewModels
@{
    ViewData["Title"] = "Browse & Book - LUMERA";
    Layout = null;
}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>@ViewData["Title"]</title>
    <link href="https://fonts.googleapis.com" rel="preconnect" />
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect" />
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;700;800&display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#13a4ec",
                        "background-light": "#f6f7f8",
                        "background-dark": "#101c22",
                    },
                    fontFamily: { "display": ["Manrope"] },
                },
            },
        }
    </script>
    <style>
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }

        .service-card {
            transition: all 0.3s ease;
        }

            .service-card:hover {
                transform: translateY(-4px);
                box-shadow: 0 12px 24px rgba(0,0,0,0.15);
            }
    </style>
</head>
<body class="font-display bg-background-light text-stone-800">
    <div class="flex h-screen overflow-hidden">
        <!-- Sidebar -->
        <aside class="w-64 bg-white dark:bg-background-dark flex flex-col border-r border-stone-200 dark:border-stone-800 fixed left-0 top-0 h-screen z-30">
            <div class="p-6 flex items-center gap-3">
                <div class="bg-primary p-2 rounded-lg">
                    <span class="material-symbols-outlined text-white">event</span>
                </div>
                <h1 class="text-xl font-bold text-stone-900">LUMERA</h1>
            </div>
            <div class="px-6 py-4 border-b border-stone-200">
                <div class="flex items-center gap-3">
                    <div class="w-12 h-12 rounded-full bg-primary/20 flex items-center justify-center">
                        <span class="material-symbols-outlined text-primary">person</span>
                    </div>
                    <div>
                        <p class="font-semibold text-stone-900">@(Model.Client.User?.FirstName ?? "User") @(Model.Client.User?.LastName ?? "")</p>
                        <p class="text-sm text-stone-500">Client</p>
                    </div>
                </div>
            </div>
            <nav class="flex-1 px-4 py-2">
                <a class="flex items-center gap-3 px-4 py-2 rounded-lg hover:bg-primary/10 text-stone-600" href="/client/dashboard"><span class="material-symbols-outlined">dashboard</span> Dashboard</a>
                <a class="flex items-center gap-3 px-4 py-2 rounded-lg hover:bg-primary/10 text-stone-600" href="/client/events"><span class="material-symbols-outlined">event</span> My Events</a>
                <a class="flex items-center gap-3 px-4 py-2 rounded-lg bg-primary/10 text-primary font-bold" href="/client/browse"><span class="material-symbols-outlined">search</span> Browse & Book</a>
                <a class="flex items-center gap-3 px-4 py-2 rounded-lg hover:bg-primary/10 text-stone-600" href="/client/bookings"><span class="material-symbols-outlined">book_online</span> Bookings & Services</a>
                <a class="flex items-center gap-3 px-4 py-2 rounded-lg hover:bg-primary/10 text-stone-600" href="/client/messages"><span class="material-symbols-outlined">mail</span> Messages @if(Model.UnreadMessages > 0){
                <span class="bg-red-500 text-white text-xs rounded-full px-2 py-1 ml-auto">@Model.UnreadMessages</span>
                                }
</a>
                <a class="flex items-center gap-3 px-4 py-2 rounded-lg hover:bg-primary/10 text-stone-600" href="/client/reviews"><span class="material-symbols-outlined">reviews</span> My Reviews</a>
                <a class="flex items-center gap-3 px-4 py-2 rounded-lg hover:bg-primary/10 text-stone-600" href="/client/profile"><span class="material-symbols-outlined">settings</span> Profile Settings</a>
            </nav>
            <div class="p-4 border-t border-stone-200 mt-auto">
                <a class="flex items-center gap-3 px-4 py-2 rounded-lg hover:bg-primary/10 text-stone-600" href="/home/index"><span class="material-symbols-outlined">logout</span> Logout</a>
            </div>
        </aside>

        <!-- Main Content -->
        <div class="flex-1 flex flex-col ml-64">
            <header class="flex h-16 items-center justify-between border-b border-stone-200 dark:border-stone-800 bg-white dark:bg-background-dark px-6 fixed top-0 right-0 left-64 z-20">
                <div class="flex items-center gap-4">
                    <h2 class="text-2xl font-bold text-stone-900">Browse & Book</h2>
                    <p class="text-stone-500">Find the perfect services for your event</p>
                </div>
                <div class="flex items-center gap-4">
                    @await Html.PartialAsync("_NotificationDropdown")
                    <div class="w-10 h-10 rounded-full bg-primary/20 flex items-center justify-center">
                        <span class="material-symbols-outlined text-primary">person</span>
                    </div>
                </div>
            </header>

            <main class="flex-1 p-8 bg-background-light dark:bg-background-dark overflow-y-auto mt-16">
                <div class="max-w-7xl mx-auto">

                    <!-- Search Bar -->
                    <div class="mb-6">
                        <div class="relative">
                            <span class="material-symbols-outlined absolute left-4 top-1/2 -translate-y-1/2 text-gray-500">search</span>
                            <input id="searchInput" class="w-full rounded-lg border border-gray-300 bg-white py-3 pl-12 pr-4 text-base text-gray-900 placeholder-gray-500 focus:border-primary focus:ring-2 focus:ring-primary" placeholder="Search for services, e.g., 'wedding photographer'" />
                        </div>
                    </div>

                    <!-- Filters -->
                    <div class="mb-8 flex flex-wrap items-center gap-3">
                        <div class="relative">
                            <button onclick="toggleDropdown('categoryDropdown')" class="flex items-center gap-2 rounded-lg bg-white border border-gray-300 px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50">
                                <span id="selectedCategory">All Categories</span>
                                <span class="material-symbols-outlined text-base">expand_more</span>
                            </button>
                            <div id="categoryDropdown" class="hidden absolute top-full left-0 mt-2 w-56 rounded-lg bg-white shadow-lg border border-gray-200 z-10 max-h-64 overflow-y-auto">
                                <button onclick="filterByCategory('')" class="block w-full text-left px-4 py-2 hover:bg-gray-50 text-sm">All Categories</button>
                                <button onclick="filterByCategory('Wedding Planning')" class="block w-full text-left px-4 py-2 hover:bg-gray-50 text-sm">Wedding Planning</button>
                                <button onclick="filterByCategory('Catering')" class="block w-full text-left px-4 py-2 hover:bg-gray-50 text-sm">Catering</button>
                                <button onclick="filterByCategory('Photography')" class="block w-full text-left px-4 py-2 hover:bg-gray-50 text-sm">Photography</button>
                                <button onclick="filterByCategory('Videography')" class="block w-full text-left px-4 py-2 hover:bg-gray-50 text-sm">Videography</button>
                                <button onclick="filterByCategory('Venue')" class="block w-full text-left px-4 py-2 hover:bg-gray-50 text-sm">Venue</button>
                                <button onclick="filterByCategory('Entertainment')" class="block w-full text-left px-4 py-2 hover:bg-gray-50 text-sm">Entertainment</button>
                                <button onclick="filterByCategory('Decoration')" class="block w-full text-left px-4 py-2 hover:bg-gray-50 text-sm">Decoration</button>
                                <button onclick="filterByCategory('Transportation')" class="block w-full text-left px-4 py-2 hover:bg-gray-50 text-sm">Transportation</button>
                            </div>
                        </div>

                        <div class="relative">
                            <button onclick="toggleDropdown('priceDropdown')" class="flex items-center gap-2 rounded-lg bg-white border border-gray-300 px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50">
                                <span id="selectedPrice">All Prices</span>
                                <span class="material-symbols-outlined text-base">expand_more</span>
                            </button>
                            <div id="priceDropdown" class="hidden absolute top-full left-0 mt-2 w-56 rounded-lg bg-white shadow-lg border border-gray-200 z-10">
                                <button onclick="filterByPrice('all')" class="block w-full text-left px-4 py-2 hover:bg-gray-50 text-sm">All Prices</button>
                                <button onclick="filterByPrice('0-5000')" class="block w-full text-left px-4 py-2 hover:bg-gray-50 text-sm">₱0 - ₱5,000</button>
                                <button onclick="filterByPrice('5000-10000')" class="block w-full text-left px-4 py-2 hover:bg-gray-50 text-sm">₱5,000 - ₱10,000</button>
                                <button onclick="filterByPrice('10000-20000')" class="block w-full text-left px-4 py-2 hover:bg-gray-50 text-sm">₱10,000 - ₱20,000</button>
                                <button onclick="filterByPrice('20000+')" class="block w-full text-left px-4 py-2 hover:bg-gray-50 text-sm">₱20,000+</button>
                            </div>
                        </div>

                        <div class="relative">
                            <button onclick="toggleDropdown('ratingDropdown')" class="flex items-center gap-2 rounded-lg bg-white border border-gray-300 px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50">
                                <span id="selectedRating">All Ratings</span>
                                <span class="material-symbols-outlined text-base">expand_more</span>
                            </button>
                            <div id="ratingDropdown" class="hidden absolute top-full left-0 mt-2 w-56 rounded-lg bg-white shadow-lg border border-gray-200 z-10">
                                <button onclick="filterByRating(0)" class="block w-full text-left px-4 py-2 hover:bg-gray-50 text-sm">All Ratings</button>
                                <button onclick="filterByRating(4)" class="block w-full text-left px-4 py-2 hover:bg-gray-50 text-sm flex items-center gap-2"><span class="material-symbols-outlined text-yellow-500 text-base">star</span> 4+ Stars</button>
                                <button onclick="filterByRating(3)" class="block w-full text-left px-4 py-2 hover:bg-gray-50 text-sm flex items-center gap-2"><span class="material-symbols-outlined text-yellow-500 text-base">star</span> 3+ Stars</button>
                            </div>
                        </div>

                        <button onclick="clearFilters()" class="ml-auto flex items-center gap-2 rounded-lg px-4 py-2 text-sm font-medium text-gray-600 hover:text-primary">
                            <span class="material-symbols-outlined text-base">refresh</span>
                            Clear Filters
                        </button>
                    </div>

                    <!-- Results Count -->
                    <div class="mb-4 flex items-center justify-between">
                        <p class="text-sm text-gray-600"><span id="resultsCount">@Model.Services.Count</span> services found</p>
                        <select id="sortBy" onchange="sortServices()" class="rounded-lg border border-gray-300 px-3 py-1.5 text-sm focus:border-primary focus:ring-1 focus:ring-primary">
                            <option value="relevant">Most Relevant</option>
                            <option value="price-low">Price: Low to High</option>
                            <option value="price-high">Price: High to Low</option>
                            <option value="rating">Highest Rated</option>
                        </select>
                    </div>

                    <!-- Services Grid -->
                    <div id="servicesGrid" class="grid gap-6">
                        @foreach (var service in Model.Services)
                        {
                            <div class="service-card flex flex-col md:flex-row gap-6 rounded-xl border border-gray-200 bg-white p-4 shadow-sm"
                                 data-category="@service.Category"
                                 data-price="@service.Price"
                                 data-rating="@service.Rating"
                                 data-name="@service.ServiceName.ToLower()">
                                <div class="flex-shrink-0 md:w-1/3">
                                    <div class="h-48 w-full rounded-lg bg-gray-200 md:h-full flex items-center justify-center overflow-hidden">
                                        <span class="material-symbols-outlined text-gray-400 text-5xl">photo</span>
                                    </div>
                                </div>
                                <div class="flex flex-1 flex-col justify-between py-2">
                                    <div>
                                        <div class="flex items-start justify-between mb-2">
                                            <h3 class="text-xl font-bold text-gray-900">@service.ServiceName</h3>
                                            <span class="px-2 py-1 rounded-full bg-primary/10 text-primary text-xs font-medium">@service.Category</span>
                                        </div>
                                        <p class="mt-1 text-sm text-gray-600 line-clamp-2">@service.Description</p>
                                        <div class="mt-3 flex items-center gap-2">
                                            <div class="flex text-yellow-400">
                                                @for (int i = 1; i <= 5; i++)
                                                {
                                                    <span class="material-symbols-outlined !text-base">@(i <= service.Rating ? "star" : "star_outline")</span>
                                                }
                                            </div>
                                            <span class="text-sm text-gray-500">@service.Rating.ToString("0.0") (@service.ReviewCount reviews)</span>
                                        </div>
                                        <p class="mt-3 text-2xl font-bold text-primary">₱@service.Price.ToString("N2")</p>
                                    </div>
                                    <div class="mt-4 flex gap-3">
                                        <button onclick="viewServiceDetails(@service.ServiceID)" class="flex-1 flex items-center justify-center gap-2 rounded-lg border border-primary px-4 py-2.5 text-sm font-semibold text-primary hover:bg-primary/5">
                                            <span class="material-symbols-outlined text-base">visibility</span>
                                            View Details
                                        </button>
                                        <button onclick="bookService(@service.ServiceID)" class="flex-1 flex items-center justify-center gap-2 rounded-lg bg-primary px-4 py-2.5 text-sm font-semibold text-white hover:bg-primary/90">
                                            <span class="material-symbols-outlined text-base">event_available</span>
                                            Book Now
                                        </button>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>

                    <!-- Empty State -->
                    <div id="emptyState" class="hidden text-center py-16">
                        <span class="material-symbols-outlined text-gray-300 text-6xl mb-4">search_off</span>
                        <p class="text-gray-600 text-lg font-medium mb-2">No services found</p>
                        <p class="text-sm text-gray-500 mb-4">Try adjusting your search or filters</p>
                        <button onclick="clearFilters()" class="px-4 py-2 rounded-lg bg-primary text-white hover:bg-primary/90">Clear All Filters</button>
                    </div>

                    <!-- Pagination -->
                    <div id="pagination" class="mt-8 flex items-center justify-center gap-2">
                        <button class="flex h-10 w-10 items-center justify-center rounded-full text-gray-600 hover:bg-primary/10 hover:text-primary">
                            <span class="material-symbols-outlined">chevron_left</span>
                        </button>
                        <button class="flex h-10 w-10 items-center justify-center rounded-full bg-primary text-sm font-bold text-white">1</button>
                        <button class="flex h-10 w-10 items-center justify-center rounded-full text-sm font-medium text-gray-600 hover:bg-primary/10 hover:text-primary">2</button>
                        <button class="flex h-10 w-10 items-center justify-center rounded-full text-sm font-medium text-gray-600 hover:bg-primary/10 hover:text-primary">3</button>
                        <button class="flex h-10 w-10 items-center justify-center rounded-full text-gray-600 hover:bg-primary/10 hover:text-primary">
                            <span class="material-symbols-outlined">chevron_right</span>
                        </button>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Book Service Modal -->
    <div id="bookModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
            <h3 class="text-xl font-bold text-gray-900 mb-4">Select Event</h3>
            <p class="text-gray-600 mb-4">Choose which event you want to book this service for:</p>
            <div id="eventsList" class="space-y-2 mb-6 max-h-64 overflow-y-auto">
                <!-- Events will be loaded here -->
            </div>
            <div class="flex justify-end gap-3">
                <button onclick="closeBookModal()" class="px-4 py-2 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-50">Cancel</button>
                <button onclick="confirmBooking()" class="px-4 py-2 rounded-lg bg-primary text-white hover:bg-primary/90">Confirm Booking</button>
            </div>
        </div>
    </div>

    <script src="~/js/notifications.js"></script>
    <script>
        let currentFilters = { category: '', price: 'all', rating: 0, search: '' };
        let selectedServiceId = null;
        let selectedEventId = null;

        // Toggle Dropdown
        function toggleDropdown(id) {
            const dropdown = document.getElementById(id);
            document.querySelectorAll('[id$="Dropdown"]').forEach(d => {
                if (d.id !== id) d.classList.add('hidden');
            });
            dropdown.classList.toggle('hidden');
        }

        // Close dropdowns when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('button')) {
                document.querySelectorAll('[id$="Dropdown"]').forEach(d => d.classList.add('hidden'));
            }
        });

        // Filter by Category
        function filterByCategory(category) {
            currentFilters.category = category;
            document.getElementById('selectedCategory').textContent = category || 'All Categories';
            toggleDropdown('categoryDropdown');
            applyFilters();
        }

        // Filter by Price
        function filterByPrice(range) {
            currentFilters.price = range;
            const labels = { 'all': 'All Prices', '0-5000': '₱0 - ₱5,000', '5000-10000': '₱5,000 - ₱10,000', '10000-20000': '₱10,000 - ₱20,000', '20000+': '₱20,000+' };
            document.getElementById('selectedPrice').textContent = labels[range];
            toggleDropdown('priceDropdown');
            applyFilters();
        }

        // Filter by Rating
        function filterByRating(rating) {
            currentFilters.rating = rating;
            document.getElementById('selectedRating').textContent = rating === 0 ? 'All Ratings' : `${rating}+ Stars`;
            toggleDropdown('ratingDropdown');
            applyFilters();
        }

        // Search
        document.getElementById('searchInput').addEventListener('input', function(e) {
            currentFilters.search = e.target.value.toLowerCase();
            applyFilters();
        });

        // Apply All Filters
        function applyFilters() {
            const cards = document.querySelectorAll('.service-card');
            let visibleCount = 0;

            cards.forEach(card => {
                const category = card.dataset.category;
                const price = parseFloat(card.dataset.price);
                const rating = parseFloat(card.dataset.rating);
                const name = card.dataset.name;

                let show = true;

                // Category filter
                if (currentFilters.category && category !== currentFilters.category) show = false;

                // Price filter
                if (currentFilters.price !== 'all') {
                    const [min, max] = currentFilters.price.split('-').map(p => p.replace('+', '') === p ? parseFloat(p) : Infinity);
                    if (price < min || (max !== Infinity && price > max)) show = false;
                }

                // Rating filter
                if (currentFilters.rating > 0 && rating < currentFilters.rating) show = false;

                // Search filter
                if (currentFilters.search && !name.includes(currentFilters.search)) show = false;

                card.style.display = show ? 'flex' : 'none';
                if (show) visibleCount++;
            });

            document.getElementById('resultsCount').textContent = visibleCount;
            document.getElementById('emptyState').classList.toggle('hidden', visibleCount > 0);
            document.getElementById('servicesGrid').classList.toggle('hidden', visibleCount === 0);
            document.getElementById('pagination').classList.toggle('hidden', visibleCount === 0);
        }

        // Clear Filters
        function clearFilters() {
            currentFilters = { category: '', price: 'all', rating: 0, search: '' };
            document.getElementById('selectedCategory').textContent = 'All Categories';
            document.getElementById('selectedPrice').textContent = 'All Prices';
            document.getElementById('selectedRating').textContent = 'All Ratings';
            document.getElementById('searchInput').value = '';
            applyFilters();
        }

        // Sort Services
        function sortServices() {
            const sortBy = document.getElementById('sortBy').value;
            const grid = document.getElementById('servicesGrid');
            const cards = Array.from(grid.querySelectorAll('.service-card'));

            cards.sort((a, b) => {
                const priceA = parseFloat(a.dataset.price);
                const priceB = parseFloat(b.dataset.price);
                const ratingA = parseFloat(a.dataset.rating);
                const ratingB = parseFloat(b.dataset.rating);

                switch (sortBy) {
                    case 'price-low': return priceA - priceB;
                    case 'price-high': return priceB - priceA;
                    case 'rating': return ratingB - ratingA;
                    default: return 0;
                }
            });

            cards.forEach(card => grid.appendChild(card));
        }

        // View Service Details
        function viewServiceDetails(serviceId) {
            window.location.href = `/client/service/${serviceId}`;
        }

        // Book Service
        async function bookService(serviceId) {
            selectedServiceId = serviceId;

            // Fetch user's events
            try {
                const response = await fetch('/client/GetUserEvents');
                const data = await response.json();

                if (data.success && data.events.length > 0) {
                    const eventsList = document.getElementById('eventsList');
                    eventsList.innerHTML = data.events.map(event => `
                        <button onclick="selectEvent(${event.eventID})" class="event-option w-full text-left p-3 rounded-lg border border-gray-200 hover:border-primary hover:bg-primary/5">
                            <p class="font-medium text-gray-900">${event.eventName}</p>
                            <p class="text-sm text-gray-500">${new Date(event.eventDate).toLocaleDateString()}</p>
                        </button>
                    `).join('');

                    document.getElementById('bookModal').classList.remove('hidden');
                    document.getElementById('bookModal').classList.add('flex');
                } else {
                    alert('Please create an event first before booking services.');
                    window.location.href = '/client/events';
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error loading events. Please try again.');
            }
        }

        // Select Event
        function selectEvent(eventId) {
            selectedEventId = eventId;
            document.querySelectorAll('.event-option').forEach(btn => {
                btn.classList.remove('border-primary', 'bg-primary/10');
                btn.classList.add('border-gray-200');
            });
            event.target.closest('.event-option').classList.add('border-primary', 'bg-primary/10');
        }

        // Confirm Booking
        async function confirmBooking() {
            if (!selectedEventId) {
                alert('Please select an event');
                return;
            }

            try {
                const response = await fetch('/client/BookService', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value
                    },
                    body: JSON.stringify({
                        serviceId: selectedServiceId,
                        eventId: selectedEventId
                    })
                });

                const data = await response.json();

                if (data.success) {
                    alert('Booking request sent successfully!');
                    closeBookModal();
                    window.location.href = '/client/bookings';
                } else {
                    alert(data.message || 'Failed to book service');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error creating booking. Please try again.');
            }
        }

        // Close Modal
        function closeBookModal() {
            document.getElementById('bookModal').classList.add('hidden');
            document.getElementById('bookModal').classList.remove('flex');
            selectedServiceId = null;
            selectedEventId = null;
        }

        // Close modal on outside click
        document.getElementById('bookModal').addEventListener('click', function(e) {
            if (e.target === this) closeBookModal();
        });
    </script>
</body>
</html>