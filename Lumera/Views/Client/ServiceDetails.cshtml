@model ServiceDetailViewModel
@using Lumera.Controllers
@using Lumera.Models.ViewModels
@{
    ViewData["Title"] = "Service Details - LUMERA";
    Layout = null;
}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>@ViewData["Title"]</title>
    <link href="https://fonts.googleapis.com" rel="preconnect" />
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect" />
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;700;800&display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#13a4ec",
                        "background-light": "#f6f7f8",
                        "background-dark": "#101c22",
                    },
                    fontFamily: { "display": ["Manrope"] },
                },
            },
        }
    </script>
    <style>
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }
    </style>
</head>
<body class="font-display bg-background-light text-stone-800">
    <div class="flex h-screen overflow-hidden">
        <!-- Sidebar -->
        <aside class="w-64 bg-white flex flex-col border-r border-stone-200 fixed left-0 top-0 h-screen z-30">
            <div class="p-6 flex items-center gap-3">
                <div class="bg-primary p-2 rounded-lg">
                    <span class="material-symbols-outlined text-white">event</span>
                </div>
                <h1 class="text-xl font-bold text-stone-900">LUMERA</h1>
            </div>
            <div class="px-6 py-4 border-b border-stone-200">
                <div class="flex items-center gap-3">
                    <div class="w-12 h-12 rounded-full bg-primary/20 flex items-center justify-center">
                        <span class="material-symbols-outlined text-primary">person</span>
                    </div>
                    <div>
                        <p class="font-semibold text-stone-900">@(Model.Client.User?.FirstName ?? "User") @(Model.Client.User?.LastName ?? "")</p>
                        <p class="text-sm text-stone-500">Client</p>
                    </div>
                </div>
            </div>
            <nav class="flex-1 px-4 py-2">
                <a class="flex items-center gap-3 px-4 py-2 rounded-lg hover:bg-primary/10 text-stone-600" href="/client/dashboard"><span class="material-symbols-outlined">dashboard</span> Dashboard</a>
                <a class="flex items-center gap-3 px-4 py-2 rounded-lg hover:bg-primary/10 text-stone-600" href="/client/events"><span class="material-symbols-outlined">event</span> My Events</a>
                <a class="flex items-center gap-3 px-4 py-2 rounded-lg bg-primary/10 text-primary font-bold" href="/client/browse"><span class="material-symbols-outlined">search</span> Browse & Book</a>
                <a class="flex items-center gap-3 px-4 py-2 rounded-lg hover:bg-primary/10 text-stone-600" href="/client/bookings"><span class="material-symbols-outlined">book_online</span> Bookings & Services</a>
                <a class="flex items-center gap-3 px-4 py-2 rounded-lg hover:bg-primary/10 text-stone-600" href="/client/messages">
                    <span class="material-symbols-outlined">mail</span> Messages @if(Model.UnreadMessages > 0){
                    <span class="bg-red-500 text-white text-xs rounded-full px-2 py-1 ml-auto">@Model.UnreadMessages</span>
                                        }
                </a>
                <a class="flex items-center gap-3 px-4 py-2 rounded-lg hover:bg-primary/10 text-stone-600" href="/client/reviews"><span class="material-symbols-outlined">reviews</span> My Reviews</a>
                <a class="flex items-center gap-3 px-4 py-2 rounded-lg hover:bg-primary/10 text-stone-600" href="/client/profile"><span class="material-symbols-outlined">settings</span> Profile Settings</a>
            </nav>
            <div class="p-4 border-t border-stone-200 mt-auto">
                <a class="flex items-center gap-3 px-4 py-2 rounded-lg hover:bg-primary/10 text-stone-600" href="/home/index"><span class="material-symbols-outlined">logout</span> Logout</a>
            </div>
        </aside>

        <!-- Main Content -->
        <div class="flex-1 flex flex-col ml-64">
            <header class="flex h-16 items-center justify-between border-b border-stone-200 bg-white px-6 fixed top-0 right-0 left-64 z-20">
                <div class="flex items-center gap-4">
                    <a href="/client/browse" class="p-2 rounded-lg hover:bg-gray-100">
                        <span class="material-symbols-outlined">arrow_back</span>
                    </a>
                    <h2 class="text-2xl font-bold text-stone-900">Service Details</h2>
                </div>
                <div class="flex items-center gap-4">
                    <button class="p-2 rounded-full hover:bg-primary/10 text-stone-600">
                        <span class="material-symbols-outlined">notifications</span>
                    </button>
                    <div class="w-10 h-10 rounded-full bg-primary/20 flex items-center justify-center">
                        <span class="material-symbols-outlined text-primary">person</span>
                    </div>
                </div>
            </header>

            <main class="flex-1 p-8 bg-background-light overflow-y-auto mt-16">
                <div class="max-w-6xl mx-auto">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <!-- Main Content -->
                        <div class="lg:col-span-2 space-y-6">
                            <!-- Image Gallery -->
                            <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                                <div class="h-96 bg-gray-200 flex items-center justify-center">
                                    @if (Model.Service.Gallery != null && Model.Service.Gallery.Any())
                                    {
                                        <img src="@Model.Service.Gallery.First().ImageURL" alt="@Model.Service.ServiceName" class="w-full h-full object-cover" />
                                    }
                                    else
                                    {
                                        <span class="material-symbols-outlined text-gray-400 text-6xl">photo</span>
                                    }
                                </div>
                                @if (Model.Service.Gallery != null && Model.Service.Gallery.Count > 1)
                                {
                                    <div class="p-4 flex gap-2 overflow-x-auto">
                                        @foreach (var image in Model.Service.Gallery.Skip(1).Take(4))
                                        {
                                            <div class="w-24 h-24 flex-shrink-0 bg-gray-200 rounded-lg overflow-hidden cursor-pointer hover:opacity-75">
                                                <img src="@image.ImageURL" alt="Gallery" class="w-full h-full object-cover" />
                                            </div>
                                        }
                                    </div>
                                }
                            </div>

                            <!-- Service Information -->
                            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                                <div class="flex items-start justify-between mb-4">
                                    <div>
                                        <h1 class="text-3xl font-bold text-gray-900 mb-2">@Model.Service.ServiceName</h1>
                                        <div class="flex items-center gap-3 text-sm text-gray-600">
                                            <span class="flex items-center gap-1">
                                                <span class="material-symbols-outlined text-primary text-base">business</span>
                                                @Model.ProviderName
                                            </span>
                                            @if (!string.IsNullOrEmpty(Model.Service.Location))
                                            {
                                                <span>·</span>
                                                <span class="flex items-center gap-1">
                                                    <span class="material-symbols-outlined text-base">location_on</span>
                                                    @Model.Service.Location
                                                </span>
                                            }
                                        </div>
                                    </div>
                                    <span class="px-3 py-1 rounded-full bg-primary/10 text-primary text-sm font-medium">@Model.Service.Category</span>
                                </div>

                                <!-- Rating -->
                                <div class="flex items-center gap-4 mb-6 pb-6 border-b border-gray-200">
                                    <div class="flex items-center gap-2">
                                        <div class="flex text-yellow-400">
                                            @for (int i = 1; i <= 5; i++)
                                            {
                                                <span class="material-symbols-outlined !text-lg">@(i <= (int)Math.Round((double)Model.Service.AverageRating) ? "star" : "star_outline")</span>
                                            }
                                        </div>
                                        <span class="text-lg font-semibold text-gray-900">@Model.Service.AverageRating.ToString("0.0")</span>
                                    </div>
                                    <span class="text-gray-500">·</span>
                                    <span class="text-gray-600">@Model.Service.TotalReviews review@(Model.Service.TotalReviews != 1 ? "s" : "")</span>
                                </div>

                                <!-- Description -->
                                <div>
                                    <h3 class="text-lg font-bold text-gray-900 mb-3">About this service</h3>
                                    <p class="text-gray-600 leading-relaxed">@(Model.Service.ServiceDescription ?? "No description available.")</p>
                                </div>

                                <!-- Service Details -->
                                <div class="mt-6 pt-6 border-t border-gray-200">
                                    <h3 class="text-lg font-bold text-gray-900 mb-4">Service Details</h3>
                                    <div class="grid grid-cols-2 gap-4">
                                        <div class="flex items-start gap-3">
                                            <span class="material-symbols-outlined text-primary">category</span>
                                            <div>
                                                <p class="text-sm text-gray-500">Category</p>
                                                <p class="font-medium text-gray-900">@Model.Service.Category</p>
                                            </div>
                                        </div>
                                        @if (!string.IsNullOrEmpty(Model.Service.PriceType))
                                        {
                                            <div class="flex items-start gap-3">
                                                <span class="material-symbols-outlined text-primary">payments</span>
                                                <div>
                                                    <p class="text-sm text-gray-500">Pricing</p>
                                                    <p class="font-medium text-gray-900">@Model.Service.PriceType</p>
                                                </div>
                                            </div>
                                        }
                                        @if (!string.IsNullOrEmpty(Model.Service.Location))
                                        {
                                            <div class="flex items-start gap-3">
                                                <span class="material-symbols-outlined text-primary">location_on</span>
                                                <div>
                                                    <p class="text-sm text-gray-500">Location</p>
                                                    <p class="font-medium text-gray-900">@Model.Service.Location</p>
                                                </div>
                                            </div>
                                        }
                                        <div class="flex items-start gap-3">
                                            <span class="material-symbols-outlined text-primary">verified</span>
                                            <div>
                                                <p class="text-sm text-gray-500">Status</p>
                                                <p class="font-medium text-green-600">Verified & Active</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Reviews Section -->
                            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                                <h3 class="text-lg font-bold text-gray-900 mb-4 flex items-center gap-2">
                                    <span class="material-symbols-outlined text-primary">reviews</span>
                                    Reviews (@Model.Reviews.Count)
                                </h3>

                                @if (Model.Reviews.Any())
                                {
                                    <div class="space-y-4">
                                        @foreach (var review in Model.Reviews.Take(5))
                                        {
                                            <div class="pb-4 border-b border-gray-200 last:border-0">
                                                <div class="flex items-start justify-between mb-2">
                                                    <div class="flex items-center gap-3">
                                                        <div class="w-10 h-10 rounded-full bg-primary/20 flex items-center justify-center">
                                                            <span class="material-symbols-outlined text-primary text-lg">person</span>
                                                        </div>
                                                        <div>
                                                            <p class="font-semibold text-gray-900">@(review.Reviewer?.FirstName ?? "Client") @(review.Reviewer?.LastName ?? "")</p>
                                                            <p class="text-xs text-gray-500">@review.CreatedAt.ToString("MMMM dd, yyyy")</p>
                                                        </div>
                                                    </div>
                                                    <div class="flex text-yellow-400">
                                                        @for (int i = 1; i <= 5; i++)
                                                        {
                                                            <span class="material-symbols-outlined !text-sm">@(i <= review.Rating ? "star" : "star_outline")</span>
                                                        }
                                                    </div>
                                                </div>
                                                <p class="text-gray-600 text-sm ml-13">@review.ReviewText</p>
                                            </div>
                                        }
                                    </div>

                                    @if (Model.Reviews.Count > 5)
                                    {
                                        <button class="mt-4 text-primary font-medium text-sm hover:underline">
                                            View all @Model.Reviews.Count reviews
                                        </button>
                                    }
                                }
                                else
                                {
                                    <div class="text-center py-8">
                                        <span class="material-symbols-outlined text-gray-300 text-4xl mb-2">rate_review</span>
                                        <p class="text-gray-500">No reviews yet</p>
                                    </div>
                                }
                            </div>
                        </div>

                        <!-- Sidebar - Booking Card -->
                        <div class="lg:col-span-1">
                            <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6 sticky top-8">
                                <div class="mb-6">
                                    <p class="text-sm text-gray-500 mb-1">Starting from</p>
                                    <p class="text-3xl font-bold text-primary">₱@Model.Service.Price.ToString("N2")</p>
                                    @if (!string.IsNullOrEmpty(Model.Service.PriceType))
                                    {
                                        <p class="text-sm text-gray-500 mt-1">@Model.Service.PriceType</p>
                                    }
                                </div>

                                <button onclick="bookService(@Model.Service.ServiceID)" class="w-full flex items-center justify-center gap-2 rounded-lg bg-primary px-4 py-3 text-white font-semibold hover:bg-primary/90 transition-colors mb-3">
                                    <span class="material-symbols-outlined">event_available</span>
                                    Book This Service
                                </button>

                                <!-- Provider Info -->
                                <div class="mt-6 pt-6 border-t border-gray-200">
                                    <h4 class="font-bold text-gray-900 mb-3">About the provider</h4>
                                    <div class="flex items-center gap-3 mb-3">
                                        <div class="w-12 h-12 rounded-full bg-primary/20 flex items-center justify-center">
                                            <span class="material-symbols-outlined text-primary">business</span>
                                        </div>
                                        <div>
                                            <p class="font-semibold text-gray-900">@Model.ProviderName</p>
                                            <p class="text-sm text-gray-500">@Model.Service.ProviderType</p>
                                        </div>
                                    </div>
                                </div>

                                <!-- Quick Info -->
                                <div class="mt-6 pt-6 border-t border-gray-200 space-y-3">
                                    <div class="flex items-center gap-3 text-sm">
                                        <span class="material-symbols-outlined text-gray-400">shield</span>
                                        <span class="text-gray-600">Verified service provider</span>
                                    </div>
                                    <div class="flex items-center gap-3 text-sm">
                                        <span class="material-symbols-outlined text-gray-400">workspace_premium</span>
                                        <span class="text-gray-600">Professional service</span>
                                    </div>
                                    <div class="flex items-center gap-3 text-sm">
                                        <span class="material-symbols-outlined text-gray-400">support_agent</span>
                                        <span class="text-gray-600">24/7 customer support</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Book Service Modal (reuse from Browse.cshtml) -->
    <div id="bookModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
            <h3 class="text-xl font-bold text-gray-900 mb-4">Select Event</h3>
            <p class="text-gray-600 mb-4">Choose which event you want to book this service for:</p>
            <div id="eventsList" class="space-y-2 mb-6 max-h-64 overflow-y-auto">
                <!-- Events will be loaded here -->
            </div>
            <div class="flex justify-end gap-3">
                <button onclick="closeBookModal()" class="px-4 py-2 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-50">Cancel</button>
                <button onclick="confirmBooking()" class="px-4 py-2 rounded-lg bg-primary text-white hover:bg-primary/90">Confirm Booking</button>
            </div>
        </div>
    </div>

    <script>
        let selectedServiceId = null;
        let selectedEventId = null;

        // Book Service
        async function bookService(serviceId) {
            selectedServiceId = serviceId;

            // Fetch user's events
            try {
                const response = await fetch('/client/GetUserEvents');
                const data = await response.json();

                if (data.success && data.events.length > 0) {
                    const eventsList = document.getElementById('eventsList');
                    eventsList.innerHTML = data.events.map(event => `
                        <button onclick="selectEvent(${event.eventID})" class="event-option w-full text-left p-3 rounded-lg border border-gray-200 hover:border-primary hover:bg-primary/5">
                            <p class="font-medium text-gray-900">${event.eventName}</p>
                            <p class="text-sm text-gray-500">${new Date(event.eventDate).toLocaleDateString()}</p>
                        </button>
                    `).join('');

                    document.getElementById('bookModal').classList.remove('hidden');
                    document.getElementById('bookModal').classList.add('flex');
                } else {
                    alert('Please create an event first before booking services.');
                    window.location.href = '/client/events';
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error loading events. Please try again.');
            }
        }

        // Select Event
        function selectEvent(eventId) {
            selectedEventId = eventId;
            document.querySelectorAll('.event-option').forEach(btn => {
                btn.classList.remove('border-primary', 'bg-primary/10');
                btn.classList.add('border-gray-200');
            });
            event.target.closest('.event-option').classList.add('border-primary', 'bg-primary/10');
        }

        // Confirm Booking
        async function confirmBooking() {
            if (!selectedEventId) {
                alert('Please select an event');
                return;
            }

            try {
                const response = await fetch('/client/BookService', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        serviceId: selectedServiceId,
                        eventId: selectedEventId
                    })
                });

                const data = await response.json();

                if (data.success) {
                    alert('Booking request sent successfully!');
                    closeBookModal();
                    window.location.href = '/client/bookings';
                } else {
                    alert(data.message || 'Failed to book service');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error creating booking. Please try again.');
            }
        }

        // Close Modal
        function closeBookModal() {
            document.getElementById('bookModal').classList.add('hidden');
            document.getElementById('bookModal').classList.remove('flex');
            selectedServiceId = null;
            selectedEventId = null;
        }

        // Contact Provider
        function contactProvider() {
            alert('Contact feature coming soon! You can message the provider after booking.');
        }

        // Close modal on outside click
        document.getElementById('bookModal').addEventListener('click', function(e) {
            if (e.target === this) closeBookModal();
        });
    </script>
</body>
</html>